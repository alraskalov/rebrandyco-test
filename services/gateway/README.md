# API Gateway

## Описание

API Gateway — это центральный компонент, который маршрутизирует запросы к различным микросервисам. В нашем случае, API Gateway предоставляет доступ к микросервису Пользователей и выполняет следующие функции:

- Авторизация пользователей с помощью JWT.
- Управление аватаром пользователя (загрузка и обновление).
- Отправка запросов к микросервисам (в частности, к Users Service и Comment Service) для получения или обновления данных о пользователях.
- Реализует protected-роуты с проверкой JWT токена.
- Обработка **refresh token** для обновления истекших **access token**.

## Структура

- **users.controller.ts** — Обрабатывает запросы, связанные с пользователями (например получение данных о пользователе, обновление аватара).
- **auth.controller.ts** — Обрабатывает запросы авторизации и регистрации.
- **auth.service.ts** — Логика авторизации, включая генерацию JWT токенов.
- **users.service.ts** — Служит для взаимодействия с микросервисом Пользователей посредством TCP-транспорта.
- **main.ts** — Инициализация приложения.

## Зависимости

- **NestJS** — Основной фреймворк для создания серверного приложения.
- **@nestjs/jwt** — Библиотека для работы с JSON Web Tokens (JWT).
- **@nestjs/passport** и **passport-jwt** — Для реализации стратегии авторизации с помощью JWT.
- **@nestjs/microservices** — Для взаимодействия с микросервисами.
- **multer** и **@nestjs/platform-express** — Для обработки загрузки файлов (например аватара пользователя).
- **swagger** — Для генерации API Документации.

## Как работает API Gateway

1. **Авторизация пользователя**:

   - При получении запроса на `/auth/login` происходит проверка учетных данных.
   - Если авторизация успешна, генерируется JWT токен, который возвращается пользователю.
   - Этот токен необходимо использовать в заголовке Authorization при отправке запросов на protected-роуты.

2. **Получение информации о пользователе**:

   - Роут `/users/{id}` получает информацию о пользователе, отправляя запрос в микросервис, используя ID пользователя.

3. **Обновление аватара**:

   - Пользователь может загрузить новый аватар через `/users/{id}/avatar`. Запрос проходит через API Gateway, затем передается в микросервис для обработки.

4. **Защищенные маршруты**:

   - Protected-роуты, такие, как `/users/{id}`, требуют валидного JWT токена в заголовке Authorization.
   - Токен используется для аутентификации пользователя и проверки, что он имеет доступ к запрашиваемым данным.

5. **Обновление access token с использованием refresh token**:

   - Для защиты от истечения срока действия **access token**, API Gateway реализует возможность обновления токенов с использованием **refresh token**.
   - Когда **access token** истекает, пользователь может запросить новый **access token**, передав **refresh token** на специальном маршруте `/auth/refresh`.

   #### Как это работает:

   - Клиент пользователя должен отправить **refresh token** в теле запроса на маршрут `/auth/refresh`.
   - API Gateway проверит **refresh token** и, если он действителен, сгенерирует новый **access token**, который можно использовать для дальнейших запросов.
   - Это позволяет пользователю продолжать работать с API без повторной авторизации, даже если **access token** истек.

## Как запустить

1. Установите зависимости:

   ```bash
   npm install
   ```

2. Запустите приложение:

   ```bash
   npm run start
   ```

3. Swagger документация будет доступна по адресу:
   ```bash
   http://localhost:3000/api
   ```
